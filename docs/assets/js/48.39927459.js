(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{376:function(t,s,a){"use strict";a.r(s);var n=a(4),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h3",{attrs:{id:"_1、解决循环引用的两种宏"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1、解决循环引用的两种宏"}},[t._v("#")]),t._v(" 1、解决循环引用的两种宏")]),t._v(" "),s("p",[t._v("方式一：")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/// 引用")]),t._v("\n#define WEAK_SELF __weak __"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("typeof")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("&*self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("weakSelf = self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n#define STRONG_SELF  __strong __"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("typeof")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("&*weakSelf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" strongSelf = weakSelf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/// 检查是否为空")]),t._v("\n#define CHECK_WEAK_SELF if "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("weakSelf "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" nil"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" return"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n#define CHECK_STRONG_SELF if "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("strongSelf "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" nil"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" return"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("使用示例：")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("\nWEAK_SELF\n[self.view1 "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("xxActionWithBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NSObject "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull obj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    STRONG_SELF\n    CHECK_STRONG_SELF\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 逻辑代码")]),t._v("\n    [strongSelf.view1 configData]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("方式二：")]),t._v(" "),s("p",[t._v("参考 RAC 或者 SDWebImage 等库的实现，选择一个就好，不要重复")]),t._v(" "),s("p",[t._v("以 RAC 宏为例：")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/// 定义")]),t._v("\n#define "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("weakify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("..."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \\\n    rac_keywordify \\\n    metamacro_foreach_"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cxt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rac_weakify_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __weak"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __VA_ARGS__"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n#define "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("strongify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("..."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \\\n    rac_keywordify \\\n    _"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Pragma")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"clang diagnostic push"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \\\n    _"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Pragma")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"clang diagnostic ignored \\"-Wshadow\\""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \\\n    metamacro_"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("foreach")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rac_strongify_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __VA_ARGS__"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \\\n    _"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Pragma")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"clang diagnostic pop"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \n")])])]),s("p",[t._v("使用示例：")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("id foo = [[NSObject alloc] init]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    id bar = [[NSObject alloc] init]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    @"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("weakify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" foo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" bar"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this block will not keep 'foo' or 'bar' alive")]),t._v("\n    BOOL "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("^matchesFooOrBar"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" = ^ BOOL "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id obj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// but now, upon entry, 'foo' and 'bar' will stay alive until the block has")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// finished executing")]),t._v("\n        @"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("strongify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" foo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" bar"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n       "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 逻辑代码 (直接使用self)")]),t._v("\n   \t\t [self.view1 configData]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        return [foo "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("isEqual")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("obj] || [bar "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("isEqual")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("obj]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("⚠️  Block 内部重新声明的 self 和 block 外部的不是一个对象，只是名称相同，可以理解为block 内部定义了一个局部变量名为self的对象，而恰巧这个场景是允许的，优先取block内部的此对象。所以在内部并不会导致循环引用。")]),t._v(" "),s("h3",{attrs:{id:"_2、常规使用block场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2、常规使用block场景"}},[t._v("#")]),t._v(" 2、常规使用Block场景")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用场景")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token atrule"}},[s("span",{pre:!0,attrs:{class:"token rule"}},[t._v("@weakify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n[self.moreButton "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("addTapActionWithBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UIGestureRecognizer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull gestureRecoginzer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   @"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("strongify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  \n  \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// self ")]),t._v("\n    !self.didClickMoreBlock ?"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" self."),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("didClickMoreBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("YES"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用场景")]),t._v("\nWEAK_SELF\n[self.moreButton "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("addTapActionWithBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UIGestureRecognizer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull gestureRecoginzer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    STRONG_SELF\n    !strongSelf.didClickMoreBlock ?"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" strongSelf."),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("didClickMoreBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("YES"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"_3、block内使用指针"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3、block内使用指针"}},[t._v("#")]),t._v(" 3、Block内使用指针")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 声明变量方式")]),t._v("\n@interface xxxVC "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token selector"}},[t._v("<UITableViewDelegate, UITableViewDataSource>\n")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    NSMutableArray *_dataArray"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    NSInteger _pageNum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    NSInteger _pageSize"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 错误使用场景")]),t._v("\nWEAK_SELF\n[self.moreButton "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("addTapActionWithBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UIGestureRecognizer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull gestureRecoginzer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    STRONG_SELF\n    ...\n    \t[strongSelf->_dataArray xxx]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ...\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n=======================================\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 原因： 因为非@property 声明的属性，只能通过 strongSelf->_dataArray 的方式，而 -> 是直接通过内存地址访问实例变量的值，而不是点语法的通过属性访问器方法，这样在block延迟调用而self已经释放的情况下可能会导致直接访问内存地址异常")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 修改后")]),t._v("\n@property "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nonatomic"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" strong"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" NSMutableArray *dataArray"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用属性访问器方法")]),t._v("\n[self.moreButton "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("addTapActionWithBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UIGestureRecognizer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull gestureRecoginzer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    STRONG_SELF\n    ...\n    \t[strongSelf.dataArray xxx]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ...\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),s("h3",{attrs:{id:"_4、super-导致的内存泄露"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4、super-导致的内存泄露"}},[t._v("#")]),t._v(" 4、super 导致的内存泄露")]),t._v(" "),s("p",[t._v("部分场景block中使用super也是会内存泄露的，所以尽量避免")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("\n[self.viasInputView "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("setBlock_viasInputViewEditedCompleted")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AMapPOI "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull startPoi"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" AMapPOI "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull endPoi"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" NSArray "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull viaPois"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    STRONG_SELF\n    ...\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 直接使用了super")]),t._v("\n    [super "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("sc_routerEventWithName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("@"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxx"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("userInfo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("nil]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上述场景是实际项目中的内存泄露代码，")]),t._v("\n\n[self.viasInputView "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("setBlock_viasInputViewEditedCompleted")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AMapPOI "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull startPoi"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" AMapPOI "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull endPoi"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" NSArray "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull viaPois"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    STRONG_SELF\n    ...\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 改用strongSelf 方法调用")]),t._v("\n    [strongSelf "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("setupRouterEventWithName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("@"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ViaEditedSuccessShowDesignView"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("userInfo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("nil]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("void"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("setupRouterEventWithName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NSString *"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("eventName "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("userInfo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NSDictionary *"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token selector"}},[t._v("userInfo ")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    [super "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("sc_routerEventWithName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("eventName "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("userInfo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("userInfo]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"_5、addsubview-子view在block中调用了自己"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5、addsubview-子view在block中调用了自己"}},[t._v("#")]),t._v(" 5、addSubview 子view在block中调用了自己")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("UIButton *leftBtn = [[UIButton alloc] "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("initWithFrame")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CGRectMake")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("10"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" 6"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" 64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" 28"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nleftBtn.layer.masksToBounds = YES"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nleftBtn.layer.cornerRadius = 14"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nWEAK_SELF\n[leftBtn "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("addTapActionWithBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UIGestureRecognizer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull gestureRecoginzer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    leftBtn.selected = YES"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    weakSelf.carSwitchIndex = 1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n[self.view "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("addSubview")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("leftBtn]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上述场景 中addSubview 的对象在 block 中调用了自己，这种场景也是可能导致内存泄露的")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 修改： 使用 weak_leftBtn")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token atrule"}},[s("span",{pre:!0,attrs:{class:"token rule"}},[t._v("@weakify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" leftBtn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n[leftBtn "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("addTapActionWithBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UIGestureRecognizer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull gestureRecoginzer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    @"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("strongify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" leftBtn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n    leftBtn.selected = YES"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    self.carSwitchIndex = 1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n[self.view "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("addSubview")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("leftBtn]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"_6、-数组中包含对象使用block"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6、-数组中包含对象使用block"}},[t._v("#")]),t._v(" 6、 数组中包含对象使用block")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("- "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UITableViewCell *"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("tableView")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UITableView *"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("tableView "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("cellForRowAtIndexPath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NSIndexPath *"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token selector"}},[t._v("indexPath ")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  UITableViewXXCell *cell = [tableView "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("dequeueReusableCellWithIdentifier")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("@"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cell"')]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ...\n  \n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// cell 数组中包含对象使用block ")]),t._v("\n  cell.rightButtons = @[[MGSwipeButton "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("buttonWithTitle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("@"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"删除"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("backgroundColor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("UIColor.redColor "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("BOOL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MGSwipeTableCell "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull cell"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    if "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self.dataArray.count "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" 1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        self.tableView.mj_footer.hidden = YES"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        self.emptyView.hidden = NO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  \n ...\n  \n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上述场景虽然不是属性直接使用，但是由于其数组依然是强引用，所以也是导致内存泄露的一个原因")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 修改： 使用弱引用")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token atrule"}},[s("span",{pre:!0,attrs:{class:"token rule"}},[t._v("@weakify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tcell.rightButtons = @[[MGSwipeButton "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("buttonWithTitle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("@"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"删除"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("backgroundColor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("UIColor.redColor "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("BOOL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MGSwipeTableCell "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull cell"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token atrule"}},[s("span",{pre:!0,attrs:{class:"token rule"}},[t._v("@strongify")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    if "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self.dataArray.count "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" 1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        self.tableView.mj_footer.hidden = YES"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        self.emptyView.hidden = NO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"_7、block中使用含-self-的宏导致内存泄露"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7、block中使用含-self-的宏导致内存泄露"}},[t._v("#")]),t._v(" 7、Block中使用含 self 的宏导致内存泄露")]),t._v(" "),s("p",[t._v("（这个肉眼比较难定位）")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 以下代码存在内存泄露")]),t._v("\n...\n[self.myFamilyVM "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("queryRelationTagListCompleteBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BOOL result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tWEAK_SELF "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这里在block内部")]),t._v("\n  \n\t[weakSelf.myFamilyVM "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("familyAddRelationTag")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("tagStr "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("CompleteBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BOOL result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tSTRONG_SELF\n\t\t[strongSelf.tableHeadView "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("needHidenSwitchButton")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("YES]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t...\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 原因：嵌套block中 WEAK_SELF 宏本身置于block中了，而WEAK_SELF 的 本质是包含self 的代码块，编译插入等于block中使用了self。从而导致内存泄露")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// #define WEAK_SELF __weak __typeof(&*self)weakSelf = self;")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 修改：")]),t._v("\n\n...\nWEAK_SELF "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 应该放在最外层")]),t._v("\n[self.myFamilyVM "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("queryRelationTagListCompleteBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BOOL result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tSTRONG_SELF\n\t[strongSelf.myFamilyVM "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("familyAddRelationTag")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("tagStr "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("CompleteBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BOOL result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tSTRONG_SELF\n\t\t[strongSelf.tableHeadView "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("needHidenSwitchButton")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("YES]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t...\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"_8、嵌套block使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8、嵌套block使用"}},[t._v("#")]),t._v(" 8、嵌套block使用")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("\n...\nWEAK_SELF \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 第一层block")]),t._v("\n[self.myFamilyVM "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("queryRelationTagListCompleteBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BOOL result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tSTRONG_SELF\n\t...\n  \n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 第二层block")]),t._v("\n  [strongSelf.myFamilyVM "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("familyAddRelationTag")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("tagStr "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("CompleteBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BOOL result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t... "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 其它业务")]),t._v("\n    \n\t\t[strongSelf.tableHeadView "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("needHidenSwitchButton")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("YES]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t...\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 原因：")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上面的示例。 第二层block使用的是第一层 STRONG_SELF 宏 。这个情况什么时候会内存泄露呢")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 正常是没问题的，但是第二层回调的时候strongSelf 不一定在，这个时候业务逻辑就不对了")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果不确认是否存在耗时方法等业务逻辑，尽量嵌套block 都加上吧")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 修改：")]),t._v("\n\nWEAK_SELF \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 第一层block")]),t._v("\n[self.myFamilyVM "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("queryRelationTagListCompleteBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BOOL result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tSTRONG_SELF "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 加上1")]),t._v("\n\t...\n  \n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 第二层block")]),t._v("\n  [strongSelf.myFamilyVM "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("familyAddRelationTag")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("tagStr "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("CompleteBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BOOL result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    STRONG_SELF "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 加上2")]),t._v("\n    \n\t\t... "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 其它业务")]),t._v("\n    \n\t\t[strongSelf.tableHeadView "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("needHidenSwitchButton")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("YES]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t...\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"_9、block中使用-下划线变量"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_9、block中使用-下划线变量"}},[t._v("#")]),t._v(" 9、Block中使用 下划线变量")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("\n[self.myFamilyVM "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("familyAddRelationTag")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("tagStr "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("CompleteBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BOOL result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  [_tableHeadView "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("needHidenSwitchButton")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("YES]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 原因：")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上面的示例。 _tableHeadView 使用下划线，本质上还是self，所以要使用 weakSelf.tableHeadView  ")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 修改：")]),t._v("\n\nWEAK_SELF\n[self.myFamilyVM "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("familyAddRelationTag")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("tagStr "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("CompleteBlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BOOL result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  [weakSelf.tableHeadView "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("needHidenSwitchButton")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("YES]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),s("h3",{attrs:{id:"_10、target代理强持有导致循环引用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_10、target代理强持有导致循环引用"}},[t._v("#")]),t._v(" 10、Target代理强持有导致循环引用")]),t._v(" "),s("p",[t._v("NSTimer 为例：")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("self.scrollTimer = [NSTimer "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("scheduledTimerWithTimeInterval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("timeInterval\n                                                        "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("target")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("self\n                                                      "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("selector")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("@"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("selector")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("scrollTimerDidFire")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                                                      "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("userInfo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("nil\n                                                       "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("repeats")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("NO]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                                                       \n[[NSRunLoop currentRunLoop] "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("addTimer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("self.scrollTimer "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("forMode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("NSRunLoopCommonModes]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  \n\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 原因：")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上面的示例。iOS10.0以下系统时使用系统默认scheduledTimer方法都会被循环引用，就算是 target:传入 weakSelf 也是一样的")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 用户可以在DidDisaper  等方法进行关闭定时器，但是不可以在 dealloc 方法中销毁timer，时机太晚了，dealloc不会被调用。")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 修改：")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 对于 10 以上系统可以使用 block的方法")]),t._v("\n[NSTimer "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("scheduledTimerWithTimeInterval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("1 "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("block")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NSTimer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" _Nonnull timer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        \n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("repeats")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("YES]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 兼容iOS10.0以下系统时,要自己处理，方式有很多种")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1、进行一个 block 的 copy")]),t._v("\n#pragma mark "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("NSTimer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("private"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" 兼容iOS10.0以下系统时使用\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NSTimer *"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("weak_scheduledTimerWithTimeInterval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NSTimeInterval"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("inerval "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("repeats")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BOOL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("repeats "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("block")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("void "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("^"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("void"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token selector"}},[t._v("block ")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    return [NSTimer "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("scheduledTimerWithTimeInterval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("inerval "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("target")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("self "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("selector")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token atrule"}},[s("span",{pre:!0,attrs:{class:"token rule"}},[t._v("@selector")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("handle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("userInfo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("[block copy] "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("repeats")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("repeats]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("void"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("handle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NSTimer *"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("timer")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("^block"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("void"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" = timer.userInfo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    if "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("block"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("block")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\n⚠️ 另外：\n1、兼容iOS10.0以下系统时使用，项目最低系统升级10以上时请使用系统方法\n2、scrollView中启动\n[[NSRunLoop currentRunLoop] "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("addTimer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("self.timer "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("forMode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("NSRunLoopCommonModes]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n3、请在dealloc中 invalidate 并置nil\nif "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("_timer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   [_timer invalidate]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   _timer = nil"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2、 使用weak delegate 方式，")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// NSProxy 做中间代理等")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// NSProxy 方式是 通过 invocation 消息转发方式处理")]),t._v("\n\n")])])]),s("h3",{attrs:{id:"_11、-单例方法导致内存泄露"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_11、-单例方法导致内存泄露"}},[t._v("#")]),t._v(" 11、 单例方法导致内存泄露")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("\n1、不是所有的单例都不释放的，部分情况的单例在短时间内持有了大量内存， 在不使用的时候建议适当清理\n2、单例不要持有UI对象，避免无法释放\n\n")])])]),s("h3",{attrs:{id:"_12-、mrc与arc混编"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_12-、mrc与arc混编"}},[t._v("#")]),t._v(" 12 、MRC与ARC混编")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果文件是指定  --fno-objc-arc 的 手动管理模式，那么代码就需要手动对对象进行 release。 不然就会内存泄露")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这个场景现在比较少，一些老的项目中存在，MRC 文件代码往往因为ARC 已成习惯忘了手动进行是否，也就是手动调用 release")]),t._v("\n[xxx release]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 还有就是使用 autorelease")]),t._v("\n[[[xxx aloc] initWith xxx] autorelease]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n")])])]),s("h3",{attrs:{id:"_13-、corefoundation与foundation的桥接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_13-、corefoundation与foundation的桥接"}},[t._v("#")]),t._v(" 13 、CoreFoundation与Foundation的桥接")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 桥接其实也是 混编 场景，也是容易导致内存泄露的一种方式，因为使用习惯的问题")]),t._v("\n\n1、ARC： 针对的是 Foundation （OC 语法）代码，进行了一个引用计数管理\n2、CF：而Core Foundation（CF）中的对象是用C语言实现的，分配给CF对象的内存需要手动释放，否则会造成内存泄漏\n3、__bridge 桥接：只做类型转换，不会改变对象的内存管理权逻辑\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3.1 被桥接的对象是OC对象，那么桥接以后不需要手动释放")]),t._v("\n      NSString *aNSStr = [[NSString alloc] "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("initWithFormat")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("@"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"test"')]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      CFStringRef aCFStr = "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__bridge CFStringRef"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("aNSStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3.2 被桥接的对象是CF对象，那么桥接以后需要手动释放")]),t._v("\n\t\t\tCFStringRef aCFStr = "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFStringCreateWithCString")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NULL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"test"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" kCFStringEncodingUTF8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      NSString *aNSStr = "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__bridge NSString *"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("aCFStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFRelease")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("aCFStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这里必须释放CF对象")]),t._v("\n\n4、__bridge_transfer 桥接：除了类型转换，还会把CF对象的所有权移交到OC对象\n\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用__bridge_transfer 桥接以后不需要手动释放")]),t._v("\n\t\t\tCFStringRef aCFStr = "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFStringCreateWithCString")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NULL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"test"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" kCFStringEncodingUTF8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      4.1）NSString *aNSStr = "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__bridge_transfer NSString *"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("aCFStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// __bridge_transfer，等价于 CFBridgingRelease()")]),t._v("\n      4.2）NSString *aNSStr = "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("NSString *"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFBridgingRelease")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("aCFStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n5、使用了 __bridge_retained 将 OC 桥接成CF （__bridge_retained，等价于"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFBridgingRetain")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("）\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// __bridge_retained除了类型转换，还会把OC对象的所有权抢过来给CF对象。因此需要手动释放了")]),t._v("\n      NSString *aNSStr = [[NSString alloc] "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("initWithFormat")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("@"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"test"')]),t._v("]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  \n      5.1）CFStringRef aCFStr = "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__bridge_retained CFStringRef"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" aNSStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  \n      5.2）CFStringRef aCFStr = "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CFStringRef"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFBridgingRetain")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("aNSStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("CFRelease")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("aCFStr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这里必须释放CF对象")]),t._v("\n\n6、其他：\n在将CoreFoundation对象进行计数减少后，为避免再次访问该对象可能造成野指针访问，建议及时将对象置为NULL。\n对于CoreFoundation框架对象来说，不可重复使用CFRelease（未检测NULL）函数进行计数减少，过度释放时会发生崩溃。\n对于CGImageRef对象可以使用CGImageRelease函数（未检测NULL）\n对于CGFontRef对象可以使用CGFontRelease函数（会检测NULL）\n\n\n")])])]),s("h3",{attrs:{id:"_14-、malloc申请内存未-free导致内存泄漏"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_14-、malloc申请内存未-free导致内存泄漏"}},[t._v("#")]),t._v(" 14 、malloc申请内存未 free导致内存泄漏")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("很显然， malloc 也是C 方法，需要手动管理内存\n\n")])])]),s("h3",{attrs:{id:"_15-、nsurlsessiontask-使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_15-、nsurlsessiontask-使用"}},[t._v("#")]),t._v(" 15 、NSURLSessionTask 使用")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("NSURLSession *session = [NSURLSession sharedSession]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nNSURLSessionDataTask *dataTask = [session "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("dataTaskWithURL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("[NSURL "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("URLWithString")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("@"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://www.baidu.com"')]),t._v("]]"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n生成NSURLSessionTask及其子类对象时，该对象会处于挂起状态，此时该对象会一直常驻内存\n需要为该对象调用cancel或resume方法 进行释放\n\n")])])]),s("h3",{attrs:{id:"_16-、分类使用-dealloc-打印日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_16-、分类使用-dealloc-打印日志"}},[t._v("#")]),t._v(" 16 、分类使用 dealloc 打印日志")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("⚠️ ⚠️⚠️⚠️ 分类里不要使用dealloc方法，不然可能会出现各种异常，，，，，\n\n")])])]),s("h3",{attrs:{id:"_17-、vc-中-dealloc-释放一些对象导致异常"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_17-、vc-中-dealloc-释放一些对象导致异常"}},[t._v("#")]),t._v(" 17 、VC 中 dealloc 释放一些对象导致异常")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("有时候我们会遇到在dealloc 进行一些对象释放的代码，大部分是能正常运行，但是，有些就是可以的\n\n本人遇到一些，比如在 dealloc 中 使用 self 释放 一些 self.delegate 导致异常\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 修复：")]),t._v("\n\n不要使用self ，改使用 下划线 _\n\n")])])]),s("h3",{attrs:{id:"_18、类方法导致的内存泄露"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_18、类方法导致的内存泄露"}},[t._v("#")]),t._v(" 18、类方法导致的内存泄露")]),t._v(" "),s("p",[t._v("正常使用类方法+block 不会导致循环引用，但是使用了静态变量或全局变量，就有可能会\n发生内存泄漏。")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[t._v("\n在iOS Objective-C中，类对象"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Block")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Class Object Block"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("也称为静态Block"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("指的是在类\n方法中使用的Block。\n\n类对象Block的内存管理方式与实例对象Block不同，因为类对象Block不会引用实例变量，也\n就不会对self进行强引用。但是，如果在Block内部使用了静态变量或全局变量，就有可能会\n发生内存泄漏。\n\n具体来说，如果在类对象Block中使用了静态变量或全局变量，并且这些变量被Block所引\n用，那么就有可能会导致内存泄漏。这是因为，静态变量或全局变量的生命周期与应用程序\n的生命周期相同，如果Block被长期持有，就可能导致这些变量一直无法释放，\n为了避免这种情况发生，可以使用block修饰符来修饰静态变量或全局变量。_block修饰\n符可以使得Block内部对这些变量的引用变成弱引用，这样即使Block被长期持有，也不会导\n致这些变量无法释放。\n\n需要注意的是，在使用类对象Blockl时，一定要注意Block中对静态变量或全局变量的引用关\n系，避免出现内存泄漏问题。同时，在Block中使用block修饰符时，需要注意变量所在的\n作用域和Block所在的作用域，以免出现访问无效指针的情况。\n\n")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);