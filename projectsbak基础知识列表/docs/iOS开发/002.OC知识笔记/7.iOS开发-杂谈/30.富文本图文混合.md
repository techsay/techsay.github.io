简单实现一个由 空格、图片、文本 混合混合而成的NSAttributedString



NSAttributedString+MaasMix.h

```objective-c

#import <Foundation/Foundation.h>

NS_ASSUME_NONNULL_BEGIN


@interface BFMixAttributedString : NSObject

+ (BFMixAttributedString * (^)(double height))setupLineHeight; //行高
- (BFMixAttributedString * (^)(CGFloat length))addBlank; // 添加空白占位
- (BFMixAttributedString * (^)(UIImage *image))addImage; // 添加图片

/// parm : string, font, color
- (BFMixAttributedString * (^)(NSString *string, UIFont *font, UIColor *color))addString; // 添加字符串

/// NSMutableParagraphStyle
- (BFMixAttributedString * (^)(NSTextAlignment align))textAlignment; // 设置对齐方式
- (BFMixAttributedString * (^)(NSLineBreakMode breakMode))textLineBreakMode; // 设置截断方式

/// 结束处理
- (NSAttributedString * (^)(void))complete;

@end


@interface NSAttributedString (MaasMix)

/**
 Demo:
 
 NSAttributedString *mutAttrString = NSAttributedString
     .initWithLineHeight(28)
     .addImage(image)
     .addBlank(4)
     .addString(titleString, font, textColor)
     .complete();
 
 self.titleLabel.attributedText = mutAttrString;
 */

/// 初始化方法，需确定行高(不使用 lineSpacing)
+ (BFMixAttributedString * (^)(double height))initWithLineHeight;

@end

NS_ASSUME_NONNULL_END
```



NSAttributedString+MaasMix.m

```objective-c

#import "NSAttributedString+MaasMix.h"
#import "UIImage+Ext.h"

@interface BFMixAttributedString()

@property (nonatomic, assign) double maas_lineHeight;
@property (nonatomic, strong) NSMutableParagraphStyle *maas_paragraphStyle;
@property (nonatomic, strong) UIFont *maas_baseFont;
@property (nonatomic, strong) NSMutableAttributedString *maas_attributedString;

@end

@implementation NSAttributedString (MaasMix)

/// 确定行高，而不使用 lineSpacing
+ (BFMixAttributedString * (^)(double height))initWithLineHeight {
    return ^(double height) {
        BFMixAttributedString *mixAtt = [[BFMixAttributedString alloc] init];
        mixAtt.maas_lineHeight = height;
        return mixAtt;
    };
}


+ (NSAttributedString *)maaas_imageAttribuWithImage:(UIImage *)image lineHeight:(CGFloat)lineHeight {
    if (!image && !lineHeight) {
        return [NSAttributedString new];
    }
    CGFloat rate = 1.0;
    if (lineHeight < image.size.height) {
        rate = lineHeight / image.size.height;
    }
    // 默认image高度不大于行高
    CGSize size = CGSizeMake(image.size.width * rate, image.size.height * rate);
    return [self maaas_imageAttribuWithImage:image imgSize:size lineHeight:lineHeight];
}


+ (NSAttributedString *)maaas_imageAttribuWithImage:(UIImage *)image imgSize:(CGSize)imgSize lineHeight:(CGFloat)lineHeight {
    if (!image) {
        return [NSAttributedString new];
    }
    NSTextAttachment *attachment = [[NSTextAttachment alloc] init];
    attachment.image = image;
    attachment.bounds = CGRectMake(0, (imgSize.height - lineHeight)/2.0, imgSize.width, imgSize.height);
    NSAttributedString *attachmentString = [NSAttributedString attributedStringWithAttachment:attachment];
    return attachmentString;
}


+ (NSAttributedString *)maaas_blankAttribuWithLength:(CGFloat)length {
    // img
    UIImage *image = [UIImage sc_imageWithColor:[UIColor clearColor] size:CGSizeMake(length, 1)];
    return [self maaas_imageAttribuWithImage:image imgSize:image.size lineHeight:1];
}

+ (NSAttributedString *)maaas_attribuWithString:(NSString *)string font:(UIFont *)font color:(UIColor *)color {
    // text
    NSMutableAttributedString *titleAttrString = [[NSMutableAttributedString alloc] initWithString:string];
    [titleAttrString addAttribute:NSForegroundColorAttributeName value:color range:NSMakeRange(0, string.length)];
    [titleAttrString addAttribute:NSFontAttributeName value:font range:NSMakeRange(0, string.length)];
    return titleAttrString;
}

- (NSAttributedString *)maaas_paragraphStyleWithLineHeight:(CGFloat)lineHeight font:(UIFont *)font {
    
    // lineHeight
    NSMutableParagraphStyle *paragraphStyle = [[NSMutableParagraphStyle alloc] init];
    paragraphStyle.lineSpacing = 0;
    paragraphStyle.minimumLineHeight = lineHeight;
    paragraphStyle.maximumLineHeight = lineHeight;
    
    
    paragraphStyle.alignment = NSTextAlignmentLeft;
    paragraphStyle.lineBreakMode = NSLineBreakByTruncatingTail;
    
    NSMutableDictionary *attributes = [NSMutableDictionary dictionary];
    [attributes setObject:paragraphStyle forKey:NSParagraphStyleAttributeName];
    CGFloat baselineOffset = (lineHeight - font.lineHeight) / 4;
    [attributes setObject:@(baselineOffset) forKey:NSBaselineOffsetAttributeName];
    

    NSMutableAttributedString *mutAttrString = [[NSMutableAttributedString alloc] initWithAttributedString:self];
    [mutAttrString addAttributes:attributes range:NSMakeRange(0, mutAttrString.length)];
    return mutAttrString.copy;
}

@end


@implementation BFMixAttributedString

/// 确定行高，而不使用 lineSpacing
+ (BFMixAttributedString * (^)(double height))setupLineHeight {
    return ^(double height) {
        BFMixAttributedString *mixAtt = [[BFMixAttributedString alloc] init];
        mixAtt.maas_lineHeight = height;
        return mixAtt;
    };
}

- (BFMixAttributedString * (^)(CGFloat length))addBlank {
    return ^(CGFloat length) {
        // img
        UIImage *image = [UIImage sc_imageWithColor:[UIColor clearColor] size:CGSizeMake(length, 0.1)];
        NSTextAttachment *attachment = [[NSTextAttachment alloc] init];
        attachment.image = image;
        attachment.bounds = CGRectMake(0, 0, length, 0.1);
        NSAttributedString *attachmentString = [NSAttributedString attributedStringWithAttachment:attachment];
        
        [self addAttributedString:attachmentString];
        return self;
    };
}

- (BFMixAttributedString * (^)(UIImage *image))addImage {
    return ^(UIImage *image) {
        if (!image) {
            return self;
        }
        [self addAttributedString:[NSAttributedString maaas_imageAttribuWithImage:image lineHeight:self.maas_lineHeight]];
        return self;
    };
}


/// parm : string, font, color
- (BFMixAttributedString * (^)(NSString *string, UIFont *font, UIColor *color))addString {
    return ^(NSString *string, UIFont *font, UIColor *color) {
        [self addAttributedString:[NSAttributedString maaas_attribuWithString:string font:font color:color]];
        if (!self.maas_baseFont) {
            self.maas_baseFont = font;
        }
        return self;
    };
}

/// NSMutableParagraphStyle

- (BFMixAttributedString * (^)(UIFont *font))baseLineFont { // 设置基准字体大小
    return ^(UIFont *font) {
        self.maas_baseFont = font;
        return self;
    };
}

- (BFMixAttributedString * (^)(NSTextAlignment align))textAlignment {
    return ^(NSTextAlignment align) {
        self.maas_paragraphStyle.alignment = align;
        return self;
    };
}

- (BFMixAttributedString * (^)(NSLineBreakMode breakMode))textLineBreakMode {
    return ^(NSLineBreakMode breakMode) {
        self.maas_paragraphStyle.lineBreakMode = breakMode;
        return self;
    };
}

- (NSAttributedString * (^)(void))complete {
    return ^(void) {
        return [self maaas_complete];
    };
}



- (NSMutableParagraphStyle *)maas_paragraphStyle {
    if (!_maas_paragraphStyle) {
        _maas_paragraphStyle = [[NSMutableParagraphStyle alloc] init];
    }
    return _maas_paragraphStyle;
}

- (NSMutableAttributedString *)maas_attributedString {
    if (!_maas_attributedString) {
        _maas_attributedString = [NSMutableAttributedString new];
    }
    return _maas_attributedString;
}

/// config

- (void)addAttributedString:(NSAttributedString *)attributedString {
    if (attributedString) {
        [self.maas_attributedString appendAttributedString:attributedString];
    }
}


- (NSAttributedString *)maaas_complete {
    // lineHeight
    NSMutableParagraphStyle *paragraphStyle = self.maas_paragraphStyle;
    paragraphStyle.lineSpacing = 0;
    paragraphStyle.minimumLineHeight = self.maas_lineHeight;
    paragraphStyle.maximumLineHeight = self.maas_lineHeight;
    
    NSMutableDictionary *attributes = [NSMutableDictionary dictionary];
    [attributes setObject:paragraphStyle forKey:NSParagraphStyleAttributeName];
    
    if (self.maas_baseFont) {
        CGFloat baselineOffset = (self.maas_lineHeight - self.maas_baseFont.lineHeight) / 4;
        [attributes setObject:@(baselineOffset) forKey:NSBaselineOffsetAttributeName];
    }
    NSMutableAttributedString *mutAttrString = [[NSMutableAttributedString alloc] initWithAttributedString:self.maas_attributedString];
    [mutAttrString addAttributes:attributes range:NSMakeRange(0, mutAttrString.length)];
    return mutAttrString.copy;
}

@end

```



Demo:

```objective-c
NSAttributedString *mutAttrString = NSAttributedString
   .initWithLineHeight(28)
   .addImage(image)
   .addBlank(4)
   .addString(titleString, font, textColor)
   .complete();

self.titleLabel.attributedText = mutAttrString;
```



注意：

这是一个简单混合场景，通过设置文本和图片使用相同行高来实现，每行内容都是一样的行高，而行间距为0

假如图片和文本的行高不一样，并且需要居中显示，那么需要兼容 基线 base line 的设置。

